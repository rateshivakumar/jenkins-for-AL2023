pipeline {
    agent any

    tools {
        nodejs 'NodeJS'
    }

    environment {
        DOCKER_REGISTRY = 'https://index.docker.io/v1/'
        DOCKER_CREDENTIALS = 'dockerhub'
        SONARQUBE = 'sonar'
    }

    stages {

        stage('Checkout Code') {
            steps {
                echo "üì• Checking out code from GitHub"
                git branch: 'main',
                    url: 'https://github.com/rateshivakumar/ZaltixSchool.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('backend') {
                    echo "üì¶ Installing backend Node.js dependencies"
                    sh 'npm install'
                }
                dir('sphere-entry-animated-home-main') {
                    echo "üì¶ Installing web Node.js dependencies"
                    sh 'npm install'
                }
                dir('Eshcul') {
                    echo "üì¶ Installing mobile Node.js dependencies"
                    sh 'npm install'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONARQUBE}") {
                    withCredentials([string(credentialsId: 'sonar-scanner', variable: 'SONAR_TOKEN')]) {
                        withEnv(["PATH+SONAR=${tool 'SonarQubeScanner'}/bin"]) {
                            sh '''
                                echo "üîé Checking sonar-scanner version..."
                                sonar-scanner -v

                                echo "üöÄ Running SonarQube analysis for backend..."
                                sonar-scanner \
                                  -Dsonar.projectKey=ZaltixSchool \
                                  -Dsonar.sources=backend \
                                  -Dsonar.host.url=$SONAR_HOST_URL \
                                  -Dsonar.login=$SONAR_TOKEN
                            '''
                        }
                    }
                }
            }
        }

        stage('Package Backend App') {
            steps {
                echo "üì¶ Packaging backend Node.js app into tar.gz"
                sh '''
                    cd backend
                    tar -czf ZaltixSchool-backend-${BUILD_NUMBER}.tar.gz *
                    mv ZaltixSchool-backend-${BUILD_NUMBER}.tar.gz ../
                '''
            }
        }

        stage('Upload Artifact to Nexus') {
            steps {
                nexusArtifactUploader(
                    artifacts: [[
                        artifactId: 'ZaltixSchool-backend',
                        classifier: '',
                        file: "ZaltixSchool-backend-${BUILD_NUMBER}.tar.gz",
                        type: 'tar.gz'
                    ]],
                    credentialsId: 'nexus',
                    groupId: 'in.zaltix.school',
                    nexusUrl: '52.66.248.93:8081',
                    nexusVersion: 'nexus3',
                    protocol: 'http',
                    repository: 'nodejs',
                    version: "${BUILD_NUMBER}"
                )
            }
        }

        stage('Build & Push Backend Image') {
            steps {
                script {
                    sh 'docker system prune -af || true'
                    docker.withRegistry("${DOCKER_REGISTRY}", "${DOCKER_CREDENTIALS}") {
                        def backendImage = docker.build("rateshivakumar/zaltix-backend:${BUILD_NUMBER}", "-f backend/Dockerfile backend")
                        backendImage.push()
                    }
                }
            }
        }

        stage('Build & Push Web Image') {
            steps {
                script {
                    sh 'docker system prune -af || true'
                    docker.withRegistry("${DOCKER_REGISTRY}", "${DOCKER_CREDENTIALS}") {
                        def webImage = docker.build("rateshivakumar/zaltix-web:${BUILD_NUMBER}", "-f sphere-entry-animated-home-main/Dockerfile sphere-entry-animated-home-main")
                        webImage.push()
                    }
                }
            }
        }

        stage('Build & Push Mobile Image') {
            steps {
                script {
                    sh 'docker system prune -af || true'
                    docker.withRegistry("${DOCKER_REGISTRY}", "${DOCKER_CREDENTIALS}") {
                        def mobileImage = docker.build("rateshivakumar/zaltix-mobile:${BUILD_NUMBER}", "-f Eshcul/Dockerfile Eshcul")
                        mobileImage.push()
                    }
                }
            }
        }

    }

    post {
        success {
            echo "‚úÖ Pipeline finished successfully! All images pushed to Docker Hub."
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs above."
        }
    }
}
