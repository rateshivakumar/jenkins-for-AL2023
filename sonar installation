#!/bin/bash
# =========================================
# SonarQube 8.9 LTS Installation Script
# For Amazon Linux 2023
# =========================================

# STEP 1: Go to /opt and download SonarQube
cd /opt/ || exit 1
echo "üì• Downloading SonarQube..."
wget https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-8.9.6.50800.zip
unzip sonarqube-8.9.6.50800.zip

# STEP 2: Install Java 11 (required by SonarQube 8.9 LTS)
echo "‚òï Installing Java 11..."
sudo amazon-linux-extras enable corretto11
sudo yum install -y java-11-amazon-corretto-devel
java -version

# STEP 3: Create sonar user & set permissions
echo "üë§ Creating 'sonar' user..."
sudo useradd -r -s /bin/false sonar
sudo chown -R sonar:sonar /opt/sonarqube-8.9.6.50800
sudo chmod -R 755 /opt/sonarqube-8.9.6.50800

# STEP 4: Run SonarQube as the sonar user
echo "üöÄ Starting SonarQube..."
sudo -u sonar /opt/sonarqube-8.9.6.50800/bin/linux-x86-64/sonar.sh start

# STEP 5: Check status
echo "üîé SonarQube status:"
sudo -u sonar /opt/sonarqube-8.9.6.50800/bin/linux-x86-64/sonar.sh status

# Access SonarQube UI at http://<SERVER_PUBLIC_IP>:9000
echo "‚úÖ Default login: admin / admin (change password after first login)"





=========================================================================== 



1Ô∏è‚É£ Create the service file
sudo nano /etc/systemd/system/sonarqube.service


Paste the following content:

[Unit]
Description=SonarQube service
After=syslog.target network.target

[Service]
Type=forking

# User and group to run SonarQube
User=sonar
Group=sonar

# SonarQube paths
ExecStart=/opt/sonarqube-8.9.6.50800/bin/linux-x86-64/sonar.sh start
ExecStop=/opt/sonarqube-8.9.6.50800/bin/linux-x86-64/sonar.sh stop
ExecReload=/opt/sonarqube-8.9.6.50800/bin/linux-x86-64/sonar.sh restart

# Make systemd wait a bit before killing the process
TimeoutSec=120
Restart=on-failure

[Install]
WantedBy=multi-user.target

2Ô∏è‚É£ Reload systemd and enable the service
sudo systemctl daemon-reload
sudo systemctl enable sonarqube


enable ensures it starts automatically on server reboot.

3Ô∏è‚É£ Start or restart the service manually
sudo systemctl start sonarqube
sudo systemctl restart sonarqube

4Ô∏è‚É£ Check status
sudo systemctl status sonarqube


You should see Active: active (running) and the PID of the Java process.

5Ô∏è‚É£ Verify port
sudo netstat -tulnp | grep 9000
# or
sudo ss -tulnp | grep 9000


You should see SonarQube listening on 9000.
